[{"_id":{"$objectID":"5a71d990037da90d5cbc4bc2"},"code":"class ExternalApplication {\n  constructor(context) {\n    if (!context.args) return new Error(\"No args passed to External Application\");\n    if (!context.entityRepo) return new Error(\"Invalid setup , repo cannot be null \");\n    this.register = this.register.bind(this);\n    this.validate = this.validate.bind(this);\n    this.extend = this.extend.bind(this);\n    this.context = context;\n  }\n  validate(callback) {\n    setImmediate(callback);\n  }\n  extend(callback) {\n    setImmediate(callback);\n  }\n  register(applicationClass, templates, extensions, callback) {\n    this.context.debug(\"registering a new applicant\");\n    this.context.debug(\"applicant invoiceNumber:\" + this.context.args.invoiceNumber);\n    this.context.libs.parseObjectIds.call(this.context, this.context.args);\n    this.context.debug(\"parsed object ids\");\n    this.context.debug(\"current args:\");\n    this.context.debug(JSON.stringify(this.context.args, null, \" \"));\n    let _domain,\n      reversal = false;\n\n    this.context.async.waterfall(\n      [\n        this.context.libs.getDomain.bind(this.context),\n        (domain, fn) => {\n          this.domain = domain;\n          this.context.entityRepo.get(\n            domain.config[applicationClass],\n            { invoiceNumber: this.context.args.invoiceNumber },\n            { one: true, full: true },\n            (er, application) => {\n              if (er) return fn(er);\n              fn(null, { domain, application });\n            }\n          );\n        },\n        ({ application, domain }, fn) => {\n          _domain = domain;\n          if (application) return fn(null, { newApp: application, domain, appExists: true });\n\n          this.context.debug(\"validating form state\");\n          this.validate(er => {\n            if (er) return fn(er);\n            this.context.debug(\"extending model if necessary\");\n            this.extend(er => {\n              if (er) return fn(er);\n              this.context.debug(`creating a new application of type ${applicationClass}`);\n              this.context.entityRepo.create(domain.config[applicationClass], this.context.args, (er, newApp) => {\n                if (er)\n                  return this.context.debug(`an error occurred while creating application of type ${applicationClass} error:${er}`), fn(er);\n\n                this.context.debug(`successfully created ${applicationClass}`);\n                if (!this.context.args.personalDetails || !this.context.args.personalDetails.passport) return fn(null, { domain, newApp });\n                this.context.entityRepo.infrastructure().fileUpload.moveToPermanentSite(this.context.args.personalDetails.passport, er => {\n                  if (er)\n                    return (\n                      this.context.debug(\"an error occurred while moving passport to permanent site , reversal required\"),\n                      (reversal = { _id: newApp && newApp._id, entityName: domain.config[applicationClass] }),\n                      fn(er)\n                    );\n                  return fn(null, { domain, newApp });\n                });\n              });\n            });\n          });\n        },\n        ({ domain, newApp, appExists }, fn) => {\n          if (appExists) return fn(null, newApp);\n          this.context.debug(`retrieving ${applicationClass} ${newApp}`);\n          this.context.debug(JSON.stringify(newApp));\n          this.context.entityRepo.get(domain.config[applicationClass], { _id: newApp._id }, { one: true, full: true }, fn);\n        },\n        (application, fn) => {\n          if (!application)\n            return (\n              this.context.debug(`failed to retrieve ${applicationClass}`),\n              fn(new Error(\"Could not find any application with that payment reference\"))\n            );\n          fn(null, application);\n        },\n        (application, fn) => {\n          this.context.debug(\"about to get templates\");\n          this.context.async.parallel(\n            (templates || [])\n              .map(x => {\n                return _callback => {\n                  this.context.debug(`calling mapped function ${x} , value in map ${ExternalApplication.MAP[x]}`);\n                  this.context.libs[ExternalApplication.MAP[x]].call(this.context, application, _callback);\n                };\n              })\n              .concat(\n                (extensions || []).map(x => {\n                  return _callback => {\n                    this.context.debug(\"calling extension ..\");\n                    x.call(this.context, application, _callback);\n                  };\n                })\n              ),\n            (er, _templates) => {\n              if (er) return this.context.debug(`an error occurred during the template gathering ${er}`), fn(er);\n              return fn(\n                null,\n                _templates.reduce((sum, v) => {\n                  return sum.concat(v);\n                }, [])\n              );\n            }\n          );\n        },\n        (_templates, fn) => {\n          this.context.debug(\"got templates\");\n          //this.context.debug(_templates);\n          this.context.libs.getHtmlTemplates.call(this.context, [[\"GENERAL_STYLES\"], ..._templates], _domain._id, (er, sections) => {\n            if (er) return fn(er);\n            fn(null, { sections, styles: [] });\n          });\n        },\n        (data, fn) => {\n          this.context.libs.getHtml.call(this.context, \"SECTION_TEMPLATE\", data, _domain._id, fn);\n        }\n      ],\n      (er, html) => {\n        if (reversal) return this.context.debug(\"calling reverse method\"), ExternalApplication.reversal.call(this, reversal, er, callback);\n\n        if (er) return this.context.debug(\"an error occurred during registeration returning error\"), callback(er);\n        return callback(null, { html });\n      }\n    );\n  }\n\n  getInfo(applicationClass, query, callback) {\n    if (Array.prototype.slice.call(arguments).length == 2) {\n      callback = query;\n      query = null;\n    }\n    this.context.entityRepo.get(this.context.args.$appDomain.config[applicationClass], query, callback);\n  }\n}\n\nExternalApplication.MAP = {\n  PERSONAL_DETAILS: \"preparePassportAndPersonalDetails\",\n  OLEVEL_DETAILS: \"prepareOlevelDetails\",\n  JAMB_DETAILS: \"prepareJambDetails\",\n  CHANGE_OF_DEGREE_DETAILS: \"prepareChangeOfDegreeDetails\",\n  EXECUTIVE_DIPLOMA_DETAILS: \"prepareExecutiveDiplomaDetails\"\n};\nExternalApplication.reversal = function({ _id, entityName }, er, callback) {\n  this.context.debug(\"reversing...\");\n\n  this.context.entityRepo.delete(entityName, _id, deleteError => {\n    if (!deleteError) this.context.debug(\"successfully deleted application\");\n    callback(er);\n  });\n};\nexports = ExternalApplication;\n","uid":"ExternalApplication","__v":0},{"_id":{"$objectID":"5a9d27bb31f48455489655cf"},"code":"exports = function(fn, index = 0) {\n  let e = (...rest) => {\n      index = index + 1;\n      return Object.assign({ order: index }, this.libs.createElement.apply(this, rest));\n    },\n    c = this.constants,\n    required = this.libs.createRequiredValidator,\n    businessDetails = this.libs.createElement(\"businessDetails\", \"Business Details\", \"\", c.ELEMENTTYPE.SECTION, {\n      elements: [\n        e(\"occupation\", \"Current Occupation/ Business Type\", \"\", c.ELEMENTTYPE.INPUT, { type: c.INPUTTYPE.TEXT }, [required()]),\n        e(\"organization\", \"Name of Business/ Organization\", \"\", c.ELEMENTTYPE.INPUT, { type: c.INPUTTYPE.TEXT }, [required()]),\n        e(\"yearsOfExperience\", \"Years of Experience\", \"\", c.ELEMENTTYPE.INPUT, { type: c.INPUTTYPE.NUMBER }, [required()]),\n        e(\"educationQualification\", \"Terminal Education Qualification\", \"\", c.ELEMENTTYPE.INPUT, { type: c.INPUTTYPE.TEXT }, [required()]),\n        e(\n          \"signature\",\n          \"Signature\",\n          \"\",\n          c.ELEMENTTYPE.FILEUPLOAD,\n          {\n            fileType: \"png|jpeg|jpg\",\n            showPreview: true\n          },\n          [required()]\n        )\n      ]\n    });\n\n  setImmediate(fn, null, [businessDetails], index);\n};\n","uid":"businessDetailsUI","__v":0},{"_id":{"$objectID":"5a9d55d931f48455489655f0"},"code":"exports = function(application, _fn) {\n  this.async.waterfall(\n    [\n      fn => {\n        this.entityRepo.infrastructure().fileUpload.readFile(application.businessDetails.signature, null, (er, data, description) => {\n          if (er) return fn(er);\n          if (data) application.businessDetails.signature = `data:${description.mime};base64,${data.toString(\"base64\")}`;\n          fn(null, application);\n        });\n      },\n      (application, fn) => {\n        let d = application.businessDetails;\n        fn(null, [\n          [\n            \"EXECUTIVE_DIPLOMA_DETAILS\",\n            {\n              details: [\n                [\"Current Occupation\", d.occupation],\n                [\"Name of Employer\", d.organization],\n                [\"Years of Experience\", d.yearsOfExperience],\n                [\"Terminal Educational Qualification\", d.educationQualification]\n              ],\n              signature: d.signature\n            }\n          ]\n        ]);\n      }\n    ],\n    (er, arr) => {\n      if (er) return _fn(er);\n      return _fn(null, arr);\n    }\n  );\n};\n","uid":"prepareExecutiveDiplomaDetails","__v":0}]

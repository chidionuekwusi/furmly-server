[{"_id":{"$objectID":"5a53a96292525d2238d9732f"},"code":"\r\n\t\t\t\tfunction convert(\r\n\t\t\t\t\tentityName,\r\n\t\t\t\t\tfile,\r\n\t\t\t\t\tcontext,\r\n\t\t\t\t\tchecks,\r\n\t\t\t\t\textend,\r\n\t\t\t\t\tfileUpload,\r\n\t\t\t\t\tfileParser,\r\n\t\t\t\t\tthreadPool,\r\n\t\t\t\t\tentityRepo,\r\n\t\t\t\t\tuser,\r\n\t\t\t\t\tfn\r\n\t\t\t\t) {\r\n\t\t\t\t\tfunction getDefaultChecks(_keys) {\r\n\t\t\t\t\t\treturn (rows, cb) => {\r\n\t\t\t\t\t\t\tlet errors = [],\r\n\t\t\t\t\t\t\t\trequiredKeys = _keys.sort();\r\n\t\t\t\t\t\t\tthis.debug(`sorted keys ${requiredKeys}`);\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tfor (var i = 0; i < rows.length; i++) {\r\n\t\t\t\t\t\t\t\t\tlet keys = Object.keys(rows[i]);\r\n\t\t\t\t\t\t\t\t\tif (keys.length < requiredKeys.length) {\r\n\t\t\t\t\t\t\t\t\t\terrors.push(\r\n\t\t\t\t\t\t\t\t\t\t\t`Missing column(s) row:${i + 1}`\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tlet _sortedKeys = keys.sort(),\r\n\t\t\t\t\t\t\t\t\t\tmustHave = requiredKeys.slice();\r\n\r\n\t\t\t\t\t\t\t\t\tfor (\r\n\t\t\t\t\t\t\t\t\t\tvar z = 0;\r\n\t\t\t\t\t\t\t\t\t\tz < _sortedKeys.length;\r\n\t\t\t\t\t\t\t\t\t\tz++\r\n\t\t\t\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\t\t\t\tif (rows[i][_sortedKeys[z]]) {\r\n\t\t\t\t\t\t\t\t\t\t\tmustHave.splice(\r\n\t\t\t\t\t\t\t\t\t\t\t\tmustHave.indexOf(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t_sortedKeys[z]\r\n\t\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t\t\t\t1\r\n\t\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tif (mustHave.length)\r\n\t\t\t\t\t\t\t\t\t\terrors.push(\r\n\t\t\t\t\t\t\t\t\t\t\t`row ${i +\r\n\t\t\t\t\t\t\t\t\t\t\t\t1} does not have a valid value for column(s) ${mustHave.join(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\",\"\r\n\t\t\t\t\t\t\t\t\t\t\t)}`\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tthis.debug(errors);\r\n\t\t\t\t\t\t\t\tif (errors.length) return cb(errors.join(\"|\"));\r\n\r\n\t\t\t\t\t\t\t\tcb(null, rows);\r\n\t\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\t\tcb(e);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfunction process(data, cb) {\r\n\t\t\t\t\t\tthis.debug(\"its running at all\");\r\n\t\t\t\t\t\tif (!data.items.length)\r\n\t\t\t\t\t\t\treturn cb(new Error(\"file has no rows\"));\r\n\t\t\t\t\t\tlet _innerChecks = !checks\r\n\t\t\t\t\t\t\t? null\r\n\t\t\t\t\t\t\t: Function.prototype.isPrototypeOf(checks)\r\n\t\t\t\t\t\t\t\t? checks\r\n\t\t\t\t\t\t\t\t: getDefaultChecks.call(this, checks);\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tthis.debug(\"converting items...\");\r\n\t\t\t\t\t\t\tlet joined = data.items.map((x, ind) => {\r\n\t\t\t\t\t\t\t\treturn Object.assign({}, x, data.rest || {});\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tthis.debug(\"conversion successful\");\r\n\t\t\t\t\t\t\tif (!_innerChecks) return cb(null, joined);\r\n\t\t\t\t\t\t\t_innerChecks.call(this, joined, er => {\r\n\t\t\t\t\t\t\t\tif (er) return cb(er);\r\n\t\t\t\t\t\t\t\tcb(null, joined);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\treturn cb(\r\n\t\t\t\t\t\t\t\tnew Error(\r\n\t\t\t\t\t\t\t\t\t\"error occurred processing file records\"\r\n\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdebugger;\r\n\t\t\t\t\tfileUpload.readFile(file, user, (er, data, description) => {\r\n\t\t\t\t\t\tif (er)\r\n\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\tthis.debug(\r\n\t\t\t\t\t\t\t\t\t\"An error occurred while reading uploaded file\"\r\n\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\tthis.debug(er),\r\n\t\t\t\t\t\t\t\tfn(\r\n\t\t\t\t\t\t\t\t\tnew Error(\r\n\t\t\t\t\t\t\t\t\t\t\"Error occurred while attempting to read uploaded file\"\r\n\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\tfileParser.parseOnly(description, data, (er, rows) => {\r\n\t\t\t\t\t\t\tif (er)\r\n\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\tthis.debug(\r\n\t\t\t\t\t\t\t\t\t\t\"An error occurred while parsing uploaded file\"\r\n\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\tthis.debug(er),\r\n\t\t\t\t\t\t\t\t\tfn(\r\n\t\t\t\t\t\t\t\t\t\tnew Error(\r\n\t\t\t\t\t\t\t\t\t\t\t\"Error occurred while attempting to parse uploaded file\"\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\t\tthis.debug(rows);\r\n\r\n\t\t\t\t\t\t\tprocess.call(\r\n\t\t\t\t\t\t\t\tthis,\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\titems: rows,\r\n\t\t\t\t\t\t\t\t\trest: context\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t(er, result) => {\r\n\t\t\t\t\t\t\t\t\tif (er)\r\n\t\t\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\t\t\tthis.debug(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\"an error occurred in threadpool\"\r\n\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t\t\tthis.debug(er),\r\n\t\t\t\t\t\t\t\t\t\t\tfn(\r\n\t\t\t\t\t\t\t\t\t\t\t\tnew Error(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t(Array.prototype.isPrototypeOf(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ter\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t) &&\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ter.join()) ||\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ter\r\n\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\t\t\t\tthis.debug(result);\r\n\r\n\t\t\t\t\t\t\t\t\tthis.debug(\r\n\t\t\t\t\t\t\t\t\t\t\"thread pool work completed successfully\"\r\n\t\t\t\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\t\t\t\textend =\r\n\t\t\t\t\t\t\t\t\t\textend ||\r\n\t\t\t\t\t\t\t\t\t\tfunction(list, cb) {\r\n\t\t\t\t\t\t\t\t\t\t\tsetImmediate(cb, null, list);\r\n\t\t\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\t\tthis.debug(\"finished setting up extend\");\r\n\t\t\t\t\t\t\t\t\t//this.debug(extend);\r\n\t\t\t\t\t\t\t\t\tthis.debug(extend.toString());\r\n\t\t\t\t\t\t\t\t\textend(result, (er, extendedResult) => {\r\n\t\t\t\t\t\t\t\t\t\tthis.debug(\"got here\");\r\n\t\t\t\t\t\t\t\t\t\tif (er) return fn(er);\r\n\r\n\t\t\t\t\t\t\t\t\t\tthis.debug(extendedResult);\r\n\t\t\t\t\t\t\t\t\t\tlet tasks = extendedResult.map(x =>\r\n\t\t\t\t\t\t\t\t\t\t\tentityRepo.create.bind(\r\n\t\t\t\t\t\t\t\t\t\t\t\tentityRepo,\r\n\t\t\t\t\t\t\t\t\t\t\t\tentityName,\r\n\t\t\t\t\t\t\t\t\t\t\t\tx\r\n\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t\t//this.debug(tasks);\r\n\r\n\t\t\t\t\t\t\t\t\t\tthis.async.parallel(tasks, er => {\r\n\t\t\t\t\t\t\t\t\t\t\tif (er)\r\n\t\t\t\t\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tthis.debug(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"an error occurred while saving items\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tfn(er)\r\n\t\t\t\t\t\t\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tthis.debug(\"finished!!!!\");\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tfn(\r\n\t\t\t\t\t\t\t\t\t\t\t\tnull,\r\n\t\t\t\t\t\t\t\t\t\t\t\t{info: \"Successfully uploaded records\"}\r\n\t\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\texports = convert;\r\n\t\t\t","uid":"convertFileAndSave","__v":0}]

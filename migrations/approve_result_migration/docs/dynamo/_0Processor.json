[{"_id":{"$objectID":"5ae7165ded96bc603898dc9b"},"code":"this.args.depth = true;\r\nthis.$checkDomain = true;\r\nconst objectId = prop => {\r\n  if (this.args.query && this.args.query[prop])\r\n    this.args.query[prop] = {\r\n      isObjectID: true,\r\n      value: this.args.query[prop]\r\n    };\r\n};\r\nconst run = {\r\n  extended: () => {\r\n    if (!this.args.query || !this.args.query.studentType)\r\n      return callback(null, {\r\n        items: [],\r\n        total: 0\r\n      });\r\n    objectId(\"studentType\");\r\n    objectId(\"department\");\r\n    objectId(\"semester\");\r\n    objectId(\"session\");\r\n    objectId(\"campus\");\r\n    // if(this.args.isHod) {\r\n    //     this.args.query[\"isHod\"] = this.args.isHod;\r\n    //     objectId(\"isHod\");\r\n    // }\r\n    this.debug(this.args);\r\n\r\n    let extra = {\r\n      department: this.args.query[\"department\"].value,\r\n      semester: this.args.query[\"semester\"].value,\r\n      session: this.args.query[\"session\"].value,\r\n      studentType: this.args.query[\"studentType\"].value,\r\n      campus: this.args.query[\"campus\"].value\r\n    };\r\n\r\n    if (this.args.query && this.args.query[\"campus\"]) delete this.args.query[\"campus\"];\r\n\r\n    this.libs.getEntity.call(\r\n      this,\r\n      \"CourseAssignment\",\r\n      \"\",\r\n      x => {\r\n        return Object.assign(extra, {\r\n          _id: x._id,\r\n          courseType: x.courseType.name,\r\n          courseName: x.course.name,\r\n          courseUnit: x.courseUnit,\r\n          courseCode: x.course.code,\r\n          courseId: x.course._id\r\n        });\r\n      },\r\n      (error, result) => {\r\n        if (error || !result) callback(new Error(\"could not find course assignment for the criteria\"));\r\n\r\n        if (!result.items) callback(null, result);\r\n        else {\r\n          result.items.forEach((item, index) => {\r\n            this.entityRepo.get(\r\n              \"CourseLecturerAssignment\",\r\n              {\r\n                course: item.courseId,\r\n                department: extra.department,\r\n                session: extra.session,\r\n                semester: extra.semester,\r\n                studentType: extra.studentType,\r\n                campus: extra.campus\r\n              },\r\n              {\r\n                one: true\r\n              },\r\n              (error, assignment) => {\r\n                if (assignment) {\r\n                  this.debug(assignment);\r\n                  result.items[index] = Object.assign(\r\n                    {\r\n                      lecturer: assignment.lecturer,\r\n                      courseLecturerAssignmentId: assignment._id,\r\n                      assigned: \"Assigned\"\r\n                    },\r\n                    item\r\n                  );\r\n                } else {\r\n                  result.items[index] = Object.assign(\r\n                    {\r\n                      assigned: \"Not Assigned\"\r\n                    },\r\n                    item\r\n                  );\r\n                }\r\n                if (index == result.items.length - 1) {\r\n                  callback(null, result);\r\n                }\r\n              }\r\n            );\r\n          });\r\n        }\r\n      }\r\n    );\r\n  },\r\n  stripped: () => {\r\n    if (!this.args.query)\r\n      return callback(null, {\r\n        items: [],\r\n        total: 0\r\n      });\r\n\r\n    this.entityRepo.get(\r\n      \"Staff\",\r\n      {\r\n        userId: this.args.$user._id\r\n      },\r\n      {\r\n        one: true\r\n      },\r\n      (er, staff) => {\r\n        if (er) return callback(er);\r\n        if (!staff) return callback(new Error(\"You have to be a staff to perform this operation\"));\r\n        this.args.query[\"department\"] = staff.department.toString();\r\n        this.args.query[\"lecturer\"] = staff._id.toString();\r\n        let extra = {\r\n          semester: this.args.query[\"semester\"],\r\n          session: this.args.query[\"session\"],\r\n          department: this.args.query[\"department\"]\r\n        };\r\n\r\n        objectId(\"semester\");\r\n        objectId(\"session\");\r\n        objectId(\"department\");\r\n        objectId(\"lecturer\");\r\n\r\n        this.debug(this.args.query);\r\n\r\n        this.libs.getEntity.call(\r\n          this,\r\n          \"CourseLecturerAssignment\",\r\n          \"\",\r\n          x => {\r\n            return Object.assign(extra, {\r\n              _id: x._id,\r\n              courseLecturerAssignmentId: x._id,\r\n              courseName: x.course.name,\r\n              courseCode: x.course.code,\r\n              courseId: x.course._id\r\n            });\r\n          },\r\n          (error, result) => {\r\n            this.debug(result);\r\n            if (error || !result || (result && result.items.length < 1))\r\n              callback(new Error(\"could not find course assignment for the criteria\"));\r\n\r\n            callback(null, result);\r\n          }\r\n        );\r\n      }\r\n    );\r\n  }\r\n};\r\n\r\nif (this.args.query && this.args.query[\"department\"]) run[\"extended\"]();\r\nelse run[\"stripped\"]();\r\n","title":"Get Course Lecturer assignment","requiresIdentity":true,"standalone":true,"__v":0},{"_id":{"$objectID":"5aeae84ab8ff605b883f098b"},"code":"let inf = this.entityRepo.infrastructure(),\n  fileUpload = inf.fileUpload,\n  fileParser = inf.fileParser,\n  threadPool = inf.threadPool;\nthis.debug(\"=============================================================\");\nthis.debug(this.args);\nthis.libs.parseObjectIds.call(this, this.args);\n\nlet uploadResult = () => {\n  this.entityRepo.get(\"Staff\", { userId: this.args.$user._id }, { one: true }, (error, staff) => {\n    if (error || !staff) callback(new Error(\"No staff details could be found\"));\n\n    let args = this.args.entity,\n      contx = {\n        semester: args.semester,\n        session: args.session,\n        department: args.department,\n        course: args.courseId,\n        lecturer: staff._id,\n        courseLecturerAssignmentId: args.courseLecturerAssignmentId\n      };\n    this.libs.convertFileAndSave(\n      this.args.$domain.config.resultClass,\n      args.file,\n      contx,\n      [\"regNo\", \"fullName\", \"examScore\", \"courseCode\", \"examDate\"],\n      null,\n      fileUpload,\n      fileParser,\n      threadPool,\n      this.entityRepo,\n      this.args.$user,\n      callback\n    );\n  });\n};\n\nif (!fileUpload || !fileParser || !threadPool) {\n  this.debug(`something is undefined ...fileUpload:${!!fileUpload}, fileParser:${!!fileParser}, threadPool:${!!threadPool}`),\n    callback(new Error(\"Infrastructure has a problem\"));\n} else if (!this.args.entity && !this.args.entity.file) {\n  this.debug(\"user didnt upload any file\");\n  callback(new Error(\"Missing Result file. Try uploading the file again, if this was already done.\"));\n} else uploadResult();\n","title":"upload student results","uid":"UPLOAD_STUDENT_RESULT","requiresIdentity":true,"standalone":true,"__v":0},{"_id":{"$objectID":"5aec75fabebc0b490c108b8f"},"code":"this.async.parallel(\n  [\n    cb => {\n      this.entityRepo.infrastructure().userManager.getUserById(this.args.$user._id, (error, user) => {\n        let isHod = this.entityRepo.infrastructure().userManager.inRole(this.args.$domain.config[\"hodRole\"], user);\n        if (isHod) {\n          this.entityRepo.get(\n            this.args.$domain.config[\"resultClass\"],\n            { courseLecturerAssignmentId: this.args.entity.courseLecturerAssignmentId },\n            (error, assignments) => {\n              assignments.forEach((assignment, index) => {\n                this.entityRepo.update(\n                  this.args.$domain.config[\"resultClass\"],\n                  { _id: assignment._id, approved: this.args.entity.approved },\n                  (error, result) => {\n                    if (error || !result) cb(error);\n                    if (index == assignments.length - 1) {\n                      cb(null, result);\n                    }\n                  }\n                );\n              });\n            }\n          );\n        }\n      });\n    },\n    cb => {\n      this.entityRepo.get(\"Staff\", { userId: this.args.$user._id }, { one: true }, (error, staff) => {\n        if (error) cb(new Error(\"User is not a staff\"));\n        else cb(null, staff);\n      });\n    }\n  ],\n  (error, result) => {\n    if (error) {\n      if (error instanceof Array) callback(error[0]);\n      else callback(error);\n    } else callback(null, { items: [], message: \"Result has been approved\" });\n  }\n);\n","title":"approve result","requiresIdentity":true,"standalone":true,"__v":0}]
